name: Build and Deploy

# ==========================================
# ⚠️ DEPLOYMENT & MIGRATION WARNING ⚠️
# If you are migrating this application to a new server or environment,
# you MUST update the corresponding GitHub Repository Secrets to match the
# new environment. Failure to do so will break the CI/CD pipeline.
# 
# Required Secrets to update under Settings -> Secrets and variables -> Actions:
# - SERVER_HOST, SERVER_USER, SERVER_SSH_KEY
# - DB_URL, DB_USERNAME, DB_PASSWORD
# - PROD_REDIS_* and PROD_MAIL_* configurations
# ==========================================

on:
  push:
    branches: [ "main" ]

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v3
    
    - name: Set up JDK 17
      uses: actions/setup-java@v3
      with:
        java-version: '17'
        distribution: 'temurin'
        cache: maven
        
    - name: Build with Maven
      run: mvn clean package -DskipTests
      
    - name: Upload JAR
      uses: actions/upload-artifact@v4
      with:
        name: app-jar
        path: target/*.jar

  deploy:
    needs: build
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v3

    - name: Download JAR
      uses: actions/download-artifact@v4
      with:
        name: app-jar
        path: target/
        
    - name: Clean Server
      uses: appleboy/ssh-action@master
      with:
        host: ${{ secrets.SERVER_HOST }}
        username: ${{ secrets.SERVER_USER }}
        key: ${{ secrets.SERVER_SSH_KEY }}
        script: |
          # Stop the existing application (assuming port 8080 based on application-prod.yaml)
          fuser -k 8080/tcp || true
          # Remove old artifacts to avoid version conflicts
          rm -rf /home/${{ secrets.SERVER_USER }}/app/target

    - name: Copy JAR to Server
      uses: appleboy/scp-action@master
      with:
        host: ${{ secrets.SERVER_HOST }}
        username: ${{ secrets.SERVER_USER }}
        key: ${{ secrets.SERVER_SSH_KEY }}
        source: "target/*.jar"
        target: "/home/${{ secrets.SERVER_USER }}/app"

    - name: Copy Nginx Config
      uses: appleboy/scp-action@master
      with:
        host: ${{ secrets.SERVER_HOST }}
        username: ${{ secrets.SERVER_USER }}
        key: ${{ secrets.SERVER_SSH_KEY }}
        source: "nginx/app.conf"
        target: "/home/${{ secrets.SERVER_USER }}/app"

    - name: Configure Nginx & Restart App
      uses: appleboy/ssh-action@master
      with:
        host: ${{ secrets.SERVER_HOST }}
        username: ${{ secrets.SERVER_USER }}
        key: ${{ secrets.SERVER_SSH_KEY }}
        script: |
          # Move Nginx config to the correct location (requires sudo)
          # Assuming the user has sudo privileges without password or provided via secrets (not handled here, standard assumption for CI/CD user)
          echo "${{ secrets.SERVER_USER_PASSWORD }}" | sudo -S mv /home/${{ secrets.SERVER_USER }}/app/nginx/app.conf /etc/nginx/conf.d/app.conf
          echo "${{ secrets.SERVER_USER_PASSWORD }}" | sudo -S nginx -t && echo "${{ secrets.SERVER_USER_PASSWORD }}" | sudo -S nginx -s reload

          # Navigate to the deployment directory
          cd /home/${{ secrets.SERVER_USER }}/app/target
          
          # Start the new application
          # Using nohup to keep it running after shell closes
          # Overriding DB configuration with GitHub Secrets
          nohup java -jar \
            -Dspring.profiles.active=prod \
            -Dspring.datasource.url='${{ secrets.DB_URL }}' \
            -Dspring.datasource.username='${{ secrets.DB_USERNAME }}' \
            -Dspring.datasource.password='${{ secrets.DB_PASSWORD }}' \
            -DPROD_MAIL_HOST='${{ secrets.PROD_MAIL_HOST }}' \
            -DPROD_MAIL_PORT='${{ secrets.PROD_MAIL_PORT }}' \
            -DPROD_MAIL_USERNAME='${{ secrets.PROD_MAIL_USERNAME }}' \
            -DPROD_MAIL_PASSWORD='${{ secrets.PROD_MAIL_PASSWORD }}' \
            -DPROD_REDIS_HOST='${{ secrets.PROD_REDIS_HOST }}' \
            -DPROD_REDIS_PORT='${{ secrets.PROD_REDIS_PORT }}' \
            -DPROD_REDIS_PASSWORD='${{ secrets.PROD_REDIS_PASSWORD }}' \
            *.jar > ../app.log 2>&1 &
