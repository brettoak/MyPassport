name: Build and Deploy

on:
  push:
    branches: [ "main" ]

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v3
    
    - name: Set up JDK 17
      uses: actions/setup-java@v3
      with:
        java-version: '17'
        distribution: 'temurin'
        cache: maven
        
    - name: Build with Maven
      run: mvn clean package -DskipTests
      
    - name: Upload JAR
      uses: actions/upload-artifact@v4
      with:
        name: app-jar
        path: target/*.jar

  deploy:
    needs: build
    runs-on: ubuntu-latest
    steps:
    - name: Download JAR
      uses: actions/download-artifact@v4
      with:
        name: app-jar
        path: target/
        
    - name: Clean Server
      uses: appleboy/ssh-action@master
      with:
        host: ${{ secrets.SERVER_HOST }}
        username: ${{ secrets.SERVER_USER }}
        key: ${{ secrets.SERVER_SSH_KEY }}
        script: |
          # Stop the existing application
          fuser -k 8089/tcp || true
          # Remove old artifacts to avoid version conflicts
          rm -rf /home/${{ secrets.SERVER_USER }}/app/target

    - name: Copy JAR to Server
      uses: appleboy/scp-action@master
      with:
        host: ${{ secrets.SERVER_HOST }}
        username: ${{ secrets.SERVER_USER }}
        key: ${{ secrets.SERVER_SSH_KEY }}
        source: "target/*.jar"
        target: "/home/${{ secrets.SERVER_USER }}/app"
        
    - name: Restart Application on Server
      uses: appleboy/ssh-action@master
      with:
        host: ${{ secrets.SERVER_HOST }}
        username: ${{ secrets.SERVER_USER }}
        key: ${{ secrets.SERVER_SSH_KEY }}
        script: |
          # Navigate to the deployment directory
          cd /home/${{ secrets.SERVER_USER }}/app/target
          
          # Start the new application
          # Using nohup to keep it running after shell closes
          # Overriding DB configuration with GitHub Secrets
          nohup java -jar \
            -Dspring.profiles.active=prod \
            -Dspring.datasource.url='${{ secrets.DB_URL }}' \
            -Dspring.datasource.username='${{ secrets.DB_USERNAME }}' \
            -Dspring.datasource.password='${{ secrets.DB_PASSWORD }}' \
            -DPROD_MAIL_HOST='${{ secrets.PROD_MAIL_HOST }}' \
            -DPROD_MAIL_PORT='${{ secrets.PROD_MAIL_PORT }}' \
            -DPROD_MAIL_USERNAME='${{ secrets.PROD_MAIL_USERNAME }}' \
            -DPROD_MAIL_PASSWORD='${{ secrets.PROD_MAIL_PASSWORD }}' \
            *.jar > ../app.log 2>&1 &
